

文件系统

文件系统环境与任务

    文件系统的上层是文件系统接口，这个接口通常以一棵文件目录树呈现（严格的说其实是有限状态自动机，因为支持硬连接）。
    文件由系统调用中断处理程序或其他内核程序调用，因此文件系统程序也运行在被中断进程的内核态栈中。
    文件系统的下层是设备驱动程序。典型的驱动是硬盘驱动程序。硬盘驱动程序将硬盘抽象成一个巨大的字节数组供文件系统使用。
    文件系统对设备的使用还要经过一层缓冲区。文件系统对所有数据的读写都需要首先将块设备中的数据读到缓冲区中然后再进行读写，最后再将数据写回到块设备中。可以说缓冲区封装了文件系统对设备的使用，以提供更高的读写速度。

    因此文件系统的本质是：使用一种算法，将巨大的字节数组组织成文件目录树。

文件系统实现

    Linux-0.11使用的是minix1.0的文件系统，主要使用inode实现。

    磁盘首先被分为几个区：引导块，超级块，i节点位图，逻辑块位图，i节点区和数据区。
    引导块用于系统引导，占用磁盘第一个扇区。
    超级块存储描述文件系统的信息。
    i节点位图记录i节点的使用情况。
    逻辑块位图记录逻辑块的使用情况。
    i节点区存储所有的i节点。
    数据区存储所有的逻辑块。

i节点
    
    每个i节点然后会记录节点类型，用户号，文件长度，修改时间等信息。
    然后会记录文件具体存放在哪些逻辑块中。
    i节点使用数组i_zone[9]来记录逻辑块信息。
    i_zone[0-6]存放直接块号。
    i_zone[7]存放一次间接块的块号，一次间接块里存放1024个数据块的块号。
    i_zone[8]存放二次间接块的块号，二次间接块里存放1024个一次 间接块的块号，一次间接块再存放1024个数据块的块号。

文件类型

    linux-0.11的文件系统中支持多种文件类型，主要有：正规文件，目录文件，块设备文件，字符设备文件，管道文件，符号链接文件。
    正规文件即是普通文件。
    目录文件的文件内容里存放的是条目名与对应的i节点。
    符号链接文件存放指向一个i节点的路径名。
    块设备文件和字符设备文件都描述一个设备。
    管道文件表示一个管道。
    文件系统会对不同类型的文件采用不同的文件操作。

namei
    
    namei主要将路径名解析到对应的i节点。
    路径名是形如/dir1/dir2/dir3/.../dirn/的字符串，/作为分隔符，分隔符间的字符串作为目录名。
    路径解析首先从根节点开始，在根节点的目录条目中找到dir1对应的i节点，即是/dir1/对应的i节点。
    跳转到/dir1/对应的节点后解析dir2，找到dir2对应的条目，跳抓到/dir1/dir2/对应的i节点。
    这样一直跳转下去，知道解析到最后一层，即是目标i节点。

    Linux是一个宏内核，因此文件系统作为内核的一部分也运行在进程的内核态栈中。